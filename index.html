<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>–Ø–Ω–¥–µ–∫—Å –ï–¥–∞</title>
<style>
:root{--y:#FFE033;--bl:#1A1A1A;--bg:#F5F5F5;--gt:#8C8C8C;--gb:#E8E8E8;--gn:#029154;--rd:#E63946;--st:env(safe-area-inset-top,0px);--sb:env(safe-area-inset-bottom,0px)}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;font-family:-apple-system,'SF Pro Display',sans-serif;background:var(--bg)}
#app{height:100dvh;display:flex;flex-direction:column;overflow:hidden}
.topbar{background:var(--y);padding:calc(var(--st)+12px) 16px 12px;flex-shrink:0;z-index:100}
.tb-inner{display:flex;align-items:center;gap:10px}
.logo{font-size:22px;font-weight:900;color:var(--bl);flex-shrink:0}
.addr-btn{flex:1;display:flex;align-items:center;gap:6px;background:rgba(0,0,0,.09);border-radius:12px;padding:8px 12px;border:none;text-align:left;cursor:pointer;min-width:0}
.addr-btn-txt{font-size:13px;font-weight:600;color:var(--bl);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.profile-btn{width:36px;height:36px;border-radius:50%;background:rgba(0,0,0,.1);border:none;cursor:pointer;font-size:18px;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.tabs{background:var(--y);display:flex;padding:0 16px 12px;gap:8px;flex-shrink:0}
.tab{padding:7px 16px;border-radius:20px;border:none;font-size:13px;font-weight:600;cursor:pointer}
.tab.on{background:var(--bl);color:#fff}.tab:not(.on){background:rgba(0,0,0,.08);color:var(--bl)}
.content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
.content::-webkit-scrollbar{display:none}
.screen{display:none}.screen.on{display:block}

/* ‚îÄ‚îÄ ADDRESS MODAL ‚îÄ‚îÄ */
.addr-modal{position:fixed;inset:0;background:#fff;z-index:300;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .3s ease}
.addr-modal.on{transform:none}
.addr-mhead{padding:calc(var(--st)+14px) 16px 12px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--gb);flex-shrink:0}
.addr-back{background:none;border:none;font-size:24px;cursor:pointer;color:var(--bl);line-height:1}
.addr-sbox{flex:1;display:flex;align-items:center;gap:8px;background:var(--bg);border-radius:12px;padding:10px 14px}
.addr-sinp{flex:1;border:none;outline:none;font-size:15px;background:transparent}
.addr-res{overflow-y:auto;flex:1}
.addr-ri{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--gb);cursor:pointer}
.addr-ri:active{background:var(--bg)}
.aric{width:38px;height:38px;background:var(--bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.arim{font-size:14px;font-weight:600;color:var(--bl)}.aris{font-size:12px;color:var(--gt);margin-top:2px}

/* ‚îÄ‚îÄ CATALOG ‚îÄ‚îÄ */
.srch-wrap{padding:12px 16px 8px}
.srch-box{display:flex;align-items:center;gap:8px;background:#fff;border-radius:14px;padding:10px 14px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.srch-inp{flex:1;border:none;outline:none;font-size:15px;background:transparent}
.srch-inp::placeholder{color:#b0b0b0}
.banners{display:flex;gap:12px;padding:12px 16px;overflow-x:auto;scrollbar-width:none}
.banners::-webkit-scrollbar{display:none}
.bn{min-width:250px;height:106px;border-radius:20px;padding:14px;flex-shrink:0;cursor:pointer;position:relative;overflow:hidden}
.bn:active{transform:scale(.97)}
.b1{background:linear-gradient(135deg,#ff6b35,#ff3d3d)}
.b2{background:linear-gradient(135deg,#6c5ce7,#a29bfe)}
.b3{background:linear-gradient(135deg,#00b894,#00cec9)}
.bn-txt{color:#fff;font-weight:800;font-size:15px;line-height:1.25}
.bn-em{position:absolute;right:12px;top:10px;font-size:40px}
.cats{display:flex;gap:10px;padding:4px 16px 12px;overflow-x:auto;scrollbar-width:none}
.cats::-webkit-scrollbar{display:none}
.cbt{display:flex;flex-direction:column;align-items:center;gap:4px;background:#fff;border-radius:16px;padding:10px 14px;min-width:70px;border:none;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.cbt.on{background:var(--bl)}.cbt.on .cbn{color:#fff}
.cbe{font-size:24px}.cbn{font-size:11px;font-weight:600;color:var(--bl);white-space:nowrap}
.rests{padding:4px 16px;display:flex;flex-direction:column;gap:14px}
.rc{background:#fff;border-radius:20px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.06);cursor:pointer}
.rc:active{transform:scale(.98)}
.rc-img{width:100%;height:150px;background:var(--bg);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.rc-img img{width:100%;height:100%;object-fit:cover}
.rc-badge{position:absolute;top:10px;left:10px;font-size:11px;font-weight:700;padding:3px 8px;border-radius:8px;background:var(--gn);color:#fff}
.rc-info{padding:12px 14px}
.rc-name{font-size:16px;font-weight:700;color:var(--bl);margin-bottom:5px}
.rc-meta{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.rc-rat{font-size:13px;font-weight:600;color:var(--bl)}
.rc-time{font-size:13px;color:var(--gt)}
.rc-free{font-size:13px;font-weight:600;color:var(--gn)}
.rc-tags{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
.rc-tag{font-size:11px;color:var(--gt);background:var(--bg);border-radius:6px;padding:2px 7px}

/* ‚îÄ‚îÄ MENU ‚îÄ‚îÄ */
.mhero{position:relative}
.mhero-img{width:100%;height:200px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:70px;overflow:hidden}
.mhero-img img{width:100%;height:100%;object-fit:cover}
.mhero-back{position:absolute;top:calc(var(--st)+12px);left:12px;width:38px;height:38px;border-radius:50%;background:#fff;border:none;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.minfo{padding:14px 16px 10px;background:#fff}
.minfo-name{font-size:22px;font-weight:800;color:var(--bl);margin-bottom:6px}
.minfo-meta{display:flex;gap:8px;flex-wrap:wrap}
.mbadge{font-size:12px;font-weight:600;padding:3px 10px;border-radius:10px}
.mbg{background:#e8f8ee;color:var(--gn)}.mby{background:#fff5d0;color:#9a7400}
.mcats{display:flex;gap:8px;padding:10px 16px;overflow-x:auto;scrollbar-width:none;border-top:1px solid var(--gb);background:#fff;position:sticky;top:0;z-index:50}
.mcats::-webkit-scrollbar{display:none}
.mct{padding:6px 14px;border-radius:20px;border:none;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap}
.mct.on{background:var(--bl);color:#fff}.mct:not(.on){background:var(--bg);color:var(--bl)}
.msec{padding:16px 16px 0}
.msec-title{font-size:18px;font-weight:800;color:var(--bl);margin-bottom:12px}
.mitems{display:flex;flex-direction:column;gap:10px;margin-bottom:20px}
.mi{background:#fff;border-radius:16px;padding:12px;display:flex;gap:12px;box-shadow:0 1px 4px rgba(0,0,0,.05);cursor:pointer}
.mi:active{transform:scale(.98)}
.mi-img{width:88px;height:88px;border-radius:12px;flex-shrink:0;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:36px;overflow:hidden}
.mi-img img{width:100%;height:100%;object-fit:cover}
.mi-body{flex:1;min-width:0}
.mi-name{font-size:14px;font-weight:700;color:var(--bl);line-height:1.3;margin-bottom:4px}
.mi-desc{font-size:12px;color:var(--gt);line-height:1.4;margin-bottom:5px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.mi-w{font-size:11px;color:#bbb;margin-bottom:5px}
.mi-foot{display:flex;align-items:center;justify-content:space-between}
.mi-price{font-size:15px;font-weight:800;color:var(--bl)}
.addbtn{width:32px;height:32px;border-radius:10px;background:var(--y);border:none;cursor:pointer;font-size:20px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.addbtn:active{transform:scale(.85)}
.qc{display:flex;align-items:center;gap:6px}
.qb{width:28px;height:28px;border-radius:8px;background:var(--bg);border:none;cursor:pointer;font-size:18px;font-weight:700;color:var(--bl);display:flex;align-items:center;justify-content:center}
.qn{font-size:14px;font-weight:800;min-width:18px;text-align:center}

/* ‚îÄ‚îÄ ITEM MODAL ‚îÄ‚îÄ */
.imodal{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:flex;align-items:flex-end;opacity:0;pointer-events:none;transition:opacity .25s}
.imodal.on{opacity:1;pointer-events:all}
.imod{background:#fff;border-radius:24px 24px 0 0;width:100%;max-height:90vh;overflow-y:auto;padding-bottom:calc(20px + var(--sb));transform:translateY(100%);transition:transform .32s cubic-bezier(.34,1.56,.64,1)}
.imodal.on .imod{transform:none}
.imod-img{width:100%;height:220px;background:var(--bg);border-radius:24px 24px 0 0;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:80px;position:relative}
.imod-img img{width:100%;height:100%;object-fit:cover}
.imod-close{position:absolute;top:14px;right:14px;width:32px;height:32px;border-radius:50%;background:rgba(0,0,0,.4);border:none;cursor:pointer;color:#fff;font-size:16px;display:flex;align-items:center;justify-content:center}
.imod-body{padding:20px}
.imod-name{font-size:21px;font-weight:800;color:var(--bl);margin-bottom:8px}
.imod-desc{font-size:14px;color:var(--gt);line-height:1.5;margin-bottom:6px}
.imod-w{font-size:13px;color:#bbb;margin-bottom:16px}
.imod-og{font-size:14px;font-weight:700;color:var(--bl);margin-bottom:8px}
.imod-opts{display:flex;flex-direction:column;gap:7px;margin-bottom:18px}
.iopt{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-radius:12px;border:2px solid var(--gb);cursor:pointer}
.iopt.on{border-color:var(--bl);background:#f9f9f9}
.iopt-n{font-size:14px}.iopt-p{font-size:13px;color:var(--gt)}
.imod-row{display:flex;align-items:center;gap:12px}
.iqc{display:flex;align-items:center;gap:10px}
.iqb{width:36px;height:36px;border-radius:10px;background:var(--bg);border:none;cursor:pointer;font-size:20px;font-weight:700;color:var(--bl);display:flex;align-items:center;justify-content:center}
.iqn{font-size:18px;font-weight:800;min-width:22px;text-align:center}
.imod-add{flex:1;background:var(--y);color:var(--bl);border:none;border-radius:14px;padding:15px;font-size:15px;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:space-between}

/* ‚îÄ‚îÄ CART ‚îÄ‚îÄ */
.cart-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 32px;gap:14px;text-align:center}
.ce-icon{font-size:60px}.ce-t{font-size:20px;font-weight:800;color:var(--bl)}.ce-s{font-size:14px;color:var(--gt)}
.ce-btn{background:var(--y);color:var(--bl);border:none;border-radius:14px;padding:13px 28px;font-size:15px;font-weight:700;cursor:pointer;margin-top:8px}
.cart-wrap{padding:16px}
.cart-rname{font-size:13px;color:var(--gt);margin-bottom:12px}
.citems{display:flex;flex-direction:column;gap:10px;margin-bottom:14px}
.citem{background:#fff;border-radius:16px;padding:12px;display:flex;align-items:center;gap:10px;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.cii{width:48px;height:48px;border-radius:10px;background:var(--bg);flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:22px}
.cii img{width:100%;height:100%;object-fit:cover}
.cib{flex:1;min-width:0}.cin{font-size:13px;font-weight:700;color:var(--bl);line-height:1.3}.cio{font-size:11px;color:var(--gt)}
.cqc{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
.cqcc{display:flex;align-items:center;gap:6px}
.cqb{width:26px;height:26px;border-radius:7px;background:var(--bg);border:none;cursor:pointer;font-size:16px;font-weight:700;color:var(--bl);display:flex;align-items:center;justify-content:center}
.cqn{font-size:13px;font-weight:800;min-width:16px;text-align:center}
.promo-row{background:#fff;border-radius:16px;padding:13px;margin-bottom:13px;display:flex;gap:10px;align-items:center;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.promo-inp{flex:1;border:none;outline:none;font-size:14px;background:transparent}
.promo-apply{background:var(--y);border:none;border-radius:10px;padding:8px 13px;font-size:13px;font-weight:700;cursor:pointer}
.sum-box{background:#fff;border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.sr{display:flex;justify-content:space-between;margin-bottom:9px}
.sr:last-child{margin-bottom:0}
.sl{font-size:14px;color:var(--gt)}.sv{font-size:14px;font-weight:600;color:var(--bl)}
.sr.tot .sl,.sr.tot .sv{font-size:16px;font-weight:800;color:var(--bl)}
.sdiv{height:1px;background:var(--gb);margin:9px 0}
.sfree{color:var(--gn)}
.cobtn{width:100%;background:var(--y);color:var(--bl);border:none;border-radius:16px;padding:16px;font-size:16px;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:space-between}

/* ‚îÄ‚îÄ CHECKOUT ‚îÄ‚îÄ */
.co-sec{background:#fff;border-radius:20px;margin:12px 16px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.co-t{font-size:15px;font-weight:800;color:var(--bl);margin-bottom:12px}
.co-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--gb);cursor:pointer}
.co-row:last-child{border-bottom:none;padding-bottom:0}
.coic{width:36px;height:36px;background:var(--bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.co-bd{flex:1}.col{font-size:12px;color:var(--gt)}.cov{font-size:14px;font-weight:600;color:var(--bl)}
.pay-opts{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.popt{flex:1;min-width:80px;padding:10px 8px;border-radius:12px;border:2px solid var(--gb);text-align:center;cursor:pointer;transition:.15s}
.popt.on{border-color:var(--bl);background:var(--bl);color:#fff}
.poi{font-size:18px;margin-bottom:2px}.pon{font-size:11px;font-weight:600}
.add-card-btn{width:100%;background:var(--bg);border:2px dashed var(--gb);border-radius:12px;padding:12px;font-size:13px;font-weight:600;color:var(--gt);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
.add-card-btn:active{background:#eee}
.place-btn{margin:12px 16px calc(12px + var(--sb));width:calc(100% - 32px);background:var(--y);color:var(--bl);border:none;border-radius:16px;padding:17px;font-size:17px;font-weight:800;cursor:pointer;display:block}
.place-btn:disabled{opacity:.5}

/* ‚îÄ‚îÄ ADD CARD MODAL ‚îÄ‚îÄ */
.card-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:400;display:flex;align-items:flex-end;opacity:0;pointer-events:none;transition:opacity .25s}
.card-modal.on{opacity:1;pointer-events:all}
.card-sheet{background:#fff;border-radius:24px 24px 0 0;width:100%;height:80vh;transform:translateY(100%);transition:transform .32s cubic-bezier(.34,1.56,.64,1);display:flex;flex-direction:column;overflow:hidden}
.card-modal.on .card-sheet{transform:none}
.card-head{padding:16px 16px 0;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.card-title{font-size:17px;font-weight:800;color:var(--bl)}
.card-x{background:none;border:none;font-size:22px;cursor:pointer;color:var(--gt);line-height:1}
.card-frame{flex:1;border:none;width:100%}

/* ‚îÄ‚îÄ ORDER TRACKING ‚îÄ‚îÄ */
.ord-wrap{padding:20px 16px;text-align:center}
.ord-chk{font-size:64px;margin-bottom:16px}
.ord-t{font-size:24px;font-weight:900;color:var(--bl);margin-bottom:8px}
.ord-s{font-size:15px;color:var(--gt);margin-bottom:20px}
.ord-nr{background:#fff;border-radius:16px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.06);margin-bottom:12px}
.onrl{font-size:12px;color:var(--gt);margin-bottom:4px}.onrv{font-size:20px;font-weight:900;color:var(--bl)}
.tbox{background:#fff;border-radius:16px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,.06);margin-bottom:16px;text-align:left}
.ts{display:flex;gap:14px;margin-bottom:16px;position:relative}
.ts:last-child{margin-bottom:0}
.ts-line{position:absolute;left:14px;top:30px;width:2px;height:calc(100% + 4px);background:var(--gb)}
.ts:last-child .ts-line{display:none}
.ts-dot{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;z-index:1}
.tsd{background:var(--gn);color:#fff}.tsa{background:var(--y);animation:pulse 1.4s infinite}.tsp{background:var(--gb)}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}
.ts-l{font-size:14px;font-weight:700;color:var(--bl)}.ts-s{font-size:12px;color:var(--gt);margin-top:2px}
.ts-txt{padding-top:4px}
.back-main{width:100%;background:var(--y);color:var(--bl);border:none;border-radius:14px;padding:15px;font-size:15px;font-weight:800;cursor:pointer}

/* ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ */
.prof-head{background:var(--y);padding:calc(var(--st)+20px) 16px 24px}
.ph-row{display:flex;align-items:center;gap:12px;margin-bottom:18px}
.ph-av{width:72px;height:72px;border-radius:50%;background:rgba(0,0,0,.1);display:flex;align-items:center;justify-content:center;font-size:30px;flex-shrink:0}
.ph-name{font-size:20px;font-weight:800;color:var(--bl)}.ph-uid{font-size:12px;color:rgba(0,0,0,.45);margin-top:2px}
.ph-phone{font-size:13px;color:rgba(0,0,0,.6);margin-top:2px}
.prof-plus{display:flex;align-items:center;gap:8px;background:rgba(0,0,0,.08);border-radius:14px;padding:10px 14px}
.pp-ic{font-size:20px}.pp-txt{font-size:13px;font-weight:600;color:var(--bl);flex:1}
.pp-st{font-size:11px;font-weight:700;background:#fff;border-radius:8px;padding:3px 8px;color:var(--gt)}
.pmenu{padding:16px;display:flex;flex-direction:column;gap:10px}
.psec{background:#fff;border-radius:20px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.pitem{padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;border-bottom:1px solid var(--gb)}
.pitem:last-child{border-bottom:none}.pitem:active{background:var(--bg)}
.pic2{width:40px;height:40px;background:var(--bg);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.pib{flex:1}.pit{font-size:15px;font-weight:600;color:var(--bl)}.pis{font-size:12px;color:var(--gt);margin-top:1px}
.piar{color:var(--gt);font-size:16px}

/* ‚îÄ‚îÄ ORDERS SCREEN ‚îÄ‚îÄ */
.olist{padding:12px 16px;display:flex;flex-direction:column;gap:12px}
.ocard{background:#fff;border-radius:20px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.och{display:flex;justify-content:space-between;margin-bottom:8px;align-items:flex-start}
.ocn{font-size:14px;font-weight:800;color:var(--bl)}.ocd{font-size:12px;color:var(--gt)}
.ocr{font-size:14px;color:var(--gt);margin-bottom:6px}
.oci{font-size:13px;font-weight:600;color:var(--bl);margin-bottom:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.oci-img{width:36px;height:36px;border-radius:8px;object-fit:cover;flex-shrink:0}
.ocf{display:flex;align-items:center;justify-content:space-between}
.oct{font-size:15px;font-weight:800;color:var(--bl)}
.obdg{font-size:11px;font-weight:700;padding:3px 10px;border-radius:10px}
.ob-ok{background:#e8f8ee;color:var(--gn)}.ob-no{background:#fee;color:var(--rd)}.ob-pend{background:#fff5d0;color:#9a7400}

/* ‚îÄ‚îÄ ADDRESSES ‚îÄ‚îÄ */
.acard{background:#fff;border-radius:16px;padding:14px 16px;margin:0 16px 10px;display:flex;align-items:center;gap:12px;box-shadow:0 1px 4px rgba(0,0,0,.05);cursor:pointer}
.acard:active{background:var(--bg)}
.aci{width:40px;height:40px;background:var(--bg);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.acb{flex:1}.acn{font-size:14px;font-weight:700;color:var(--bl)}.acs{font-size:12px;color:var(--gt);margin-top:2px}

/* ‚îÄ‚îÄ PAYMENTS ‚îÄ‚îÄ */
.paycard{background:#fff;border-radius:16px;padding:14px 16px;margin:0 16px 10px;display:flex;align-items:center;gap:12px;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.pci{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.pcb{flex:1}.pcn{font-size:14px;font-weight:700;color:var(--bl)}.pcs{font-size:12px;color:var(--gt);margin-top:2px}
.add-pay-btn{margin:8px 16px;width:calc(100% - 32px);background:var(--bg);border:2px dashed var(--gb);border-radius:14px;padding:14px;font-size:14px;font-weight:600;color:var(--gt);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
.add-pay-btn:active{background:#e8e8e8}

/* ‚îÄ‚îÄ PROMOS ‚îÄ‚îÄ */
.promocard{background:#fff;border-radius:16px;padding:16px;margin:0 16px 10px;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.promoCode{font-size:17px;font-weight:800;color:var(--bl);font-family:monospace;letter-spacing:1px;margin-bottom:4px}
.promoDesc{font-size:13px;color:var(--gt)}
.promoBdg{display:inline-block;margin-top:8px;font-size:11px;font-weight:700;padding:3px 10px;border-radius:8px;background:#e8f8ee;color:var(--gn)}

/* ‚îÄ‚îÄ SUPPORT ‚îÄ‚îÄ */
.sup-wrap{display:flex;flex-direction:column;height:100%}
.sup-chat{padding:16px;display:flex;flex-direction:column;gap:10px;overflow-y:auto;flex:1}
.smsg{max-width:82%;padding:11px 14px;border-radius:16px;font-size:14px;line-height:1.4}
.sbot{background:#fff;color:var(--bl);align-self:flex-start;border-bottom-left-radius:4px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.susr{background:var(--bl);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.sup-inp-row{padding:12px 16px calc(12px + var(--sb));background:#fff;border-top:1px solid var(--gb);display:flex;gap:10px;flex-shrink:0}
.sup-inp{flex:1;border:1px solid var(--gb);border-radius:20px;padding:10px 14px;font-size:14px;outline:none;background:var(--bg)}
.sup-send{width:40px;height:40px;border-radius:50%;background:var(--y);border:none;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.scr-hdr{display:flex;align-items:center;gap:10px;padding:calc(var(--st)+12px) 16px 12px;background:#fff;position:sticky;top:0;z-index:10;border-bottom:1px solid var(--gb);flex-shrink:0}
.back-btn{background:none;border:none;font-size:24px;cursor:pointer;color:var(--bl);line-height:1}
.scr-t{font-size:18px;font-weight:800;color:var(--bl)}
.bottom-nav{display:flex;background:#fff;border-top:1px solid var(--gb);padding:8px 0 calc(8px + var(--sb));flex-shrink:0;z-index:100}
.nbtn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;border:none;background:transparent;cursor:pointer;padding:4px 0}
.nic{font-size:22px;position:relative;display:inline-block}
.nlbl{font-size:10px;font-weight:600;color:var(--gt)}.nbtn.on .nlbl{color:var(--bl)}
.cbdg{position:absolute;top:-4px;right:-8px;background:var(--rd);color:#fff;font-size:9px;font-weight:800;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 3px;border:2px solid #fff}
.loading{position:fixed;inset:0;background:var(--y);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity .4s;gap:10px}
.llo{font-size:40px;font-weight:900;color:var(--bl)}.lls{font-size:14px;color:rgba(0,0,0,.4)}
.toast{position:fixed;bottom:calc(76px + var(--sb));left:50%;transform:translateX(-50%) translateY(20px);background:var(--bl);color:#fff;border-radius:14px;padding:11px 20px;font-size:14px;font-weight:600;z-index:500;opacity:0;transition:all .28s;white-space:nowrap;pointer-events:none;max-width:90vw;overflow:hidden;text-overflow:ellipsis}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}
.spin-wrap{display:flex;justify-content:center;padding:40px}
.spin{width:32px;height:32px;border:3px solid var(--gb);border-top-color:var(--bl);border-radius:50%;animation:sp .8s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:60px 24px;color:var(--gt)}
.eic{font-size:46px;margin-bottom:10px}.etx{font-size:15px;font-weight:600}.esb{font-size:13px;margin-top:4px}
</style>
</head>
<body>

<div class="loading" id="loading"><div class="llo">üçî –ï–¥–∞</div><div class="lls">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
<div class="toast" id="toast"></div>

<!-- ADDRESS MODAL -->
<div class="addr-modal" id="addrModal">
  <div class="addr-mhead">
    <button class="addr-back" onclick="closeAddr()">‚Üê</button>
    <div class="addr-sbox"><span>üîç</span><input class="addr-sinp" id="addrInp" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å..." oninput="onAddrInput(this.value)" autocomplete="off"></div>
  </div>
  <div class="addr-res" id="addrRes">
    <div class="addr-ri" onclick="useGeo()"><div class="aric">üéØ</div><div><div class="arim">–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div><div class="aris">–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div></div></div>
  </div>
</div>

<!-- ITEM MODAL -->
<div class="imodal" id="imodal">
  <div class="imod">
    <div class="imod-img" id="imodImg"><button class="imod-close" onclick="closeIModal()">‚úï</button></div>
    <div class="imod-body">
      <div class="imod-name" id="imodName"></div>
      <div class="imod-desc" id="imodDesc"></div>
      <div class="imod-w" id="imodW"></div>
      <div id="imodOptsWrap" style="display:none">
        <div class="imod-og" id="imodOgTitle"></div>
        <div class="imod-opts" id="imodOpts"></div>
      </div>
      <div class="imod-row">
        <div class="iqc">
          <button class="iqb" onclick="iqAdj(-1)">‚àí</button>
          <span class="iqn" id="iqNum">1</span>
          <button class="iqb" onclick="iqAdj(1)">+</button>
        </div>
        <button class="imod-add" onclick="addFromModal()"><span>–í –∫–æ—Ä–∑–∏–Ω—É</span><span id="imodPrice"></span></button>
      </div>
    </div>
  </div>
</div>

<!-- ADD CARD MODAL -->
<div class="card-modal" id="cardModal">
  <div class="card-sheet">
    <div class="card-head">
      <span class="card-title">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É</span>
      <button class="card-x" onclick="closeCardModal()">‚úï</button>
    </div>
    <iframe class="card-frame" id="cardFrame" src="about:blank"></iframe>
  </div>
</div>

<div id="app">
  <div class="topbar" id="mainTopbar">
    <div class="tb-inner">
      <div class="logo">–ï–¥–∞</div>
      <button class="addr-btn" onclick="openAddr()">
        <span>üìç</span>
        <span class="addr-btn-txt" id="addrTxt">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        <span style="color:var(--bl);opacity:.4;font-size:10px;margin-left:2px">‚ñæ</span>
      </button>
      <button class="profile-btn" onclick="G('profile')">üë§</button>
    </div>
  </div>
  <div class="tabs" id="mainTabs">
    <button class="tab on" onclick="selTab('online',this)">–ó–∞–∫–∞–∑–∞—Ç—å</button>
    <button class="tab" onclick="selTab('offline',this)">–°—Ö–æ–¥–∏—Ç—å</button>
  </div>

  <div class="content" id="mainContent">

    <!-- CATALOG -->
    <div class="screen on" id="screen-catalog">
      <div class="srch-wrap"><div class="srch-box"><span>üîç</span><input class="srch-inp" placeholder="–†–µ—Å—Ç–æ—Ä–∞–Ω –∏–ª–∏ –±–ª—é–¥–æ" oninput="filterR(this.value)"></div></div>
      <div class="banners">
        <div class="bn b1"><span class="bn-em">üî•</span><div class="bn-txt">–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è<br>–¥–æ—Å—Ç–∞–≤–∫–∞</div></div>
        <div class="bn b2"><span class="bn-em">‚ö°</span><div class="bn-txt">–î–æ 30 –º–∏–Ω—É—Ç<br>–∏–ª–∏ —Å–∫–∏–¥–∫–∞</div></div>
        <div class="bn b3"><span class="bn-em">üéÅ</span><div class="bn-txt">–ê–∫—Ü–∏–∏<br>–∏ —Å–∫–∏–¥–∫–∏</div></div>
      </div>
      <div class="cats" id="catsList"></div>
      <div style="padding:4px 16px 10px;font-size:20px;font-weight:800;color:var(--bl)">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</div>
      <div class="rests" id="restsList"><div class="spin-wrap"><div class="spin"></div></div></div>
      <div style="height:20px"></div>
    </div>

    <!-- MENU -->
    <div class="screen" id="screen-menu">
      <div class="mhero">
        <div class="mhero-img" id="mhImg"></div>
        <button class="mhero-back" onclick="G('catalog')">‚Üê</button>
      </div>
      <div class="minfo"><div class="minfo-name" id="mhName"></div><div class="minfo-meta" id="mhMeta"></div></div>
      <div class="mcats" id="mCats"></div>
      <div id="mItems"></div>
      <div style="height:24px"></div>
    </div>

    <!-- CART -->
    <div class="screen" id="screen-cart">
      <div class="scr-hdr"><button class="back-btn" onclick="G('catalog')">‚Üê</button><span class="scr-t">–ö–æ—Ä–∑–∏–Ω–∞</span></div>
      <div class="cart-empty" id="cartEmpty">
        <div class="ce-icon">üõí</div><div class="ce-t">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è</div>
        <div class="ce-s">–î–æ–±–∞–≤—å—Ç–µ –±–ª—é–¥–∞ –∏–∑ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
        <button class="ce-btn" onclick="G('catalog')">–ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º</button>
      </div>
      <div id="cartFilled" style="display:none">
        <div class="cart-wrap">
          <div class="cart-rname" id="cRName"></div>
          <div class="citems" id="cItems"></div>
          <div class="promo-row"><span>üè∑Ô∏è</span><input class="promo-inp" id="promoInp" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥"><button class="promo-apply" onclick="applyPromo()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div>
          <div class="sum-box">
            <div class="sr"><span class="sl">–¢–æ–≤–∞—Ä—ã</span><span class="sv" id="sItems">0 ‚ÇΩ</span></div>
            <div class="sr"><span class="sl">–î–æ—Å—Ç–∞–≤–∫–∞</span><span class="sv sfree" id="sDel">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span></div>
            <div class="sr"><span class="sl">–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–±–æ—Ä</span><span class="sv" id="sFee">0 ‚ÇΩ</span></div>
            <div class="sdiv"></div>
            <div class="sr tot"><span class="sl">–ò—Ç–æ–≥–æ</span><span class="sv" id="sTot">0 ‚ÇΩ</span></div>
          </div>
          <button class="cobtn" onclick="G('checkout')"><span>–û—Ñ–æ—Ä–º–∏—Ç—å</span><span id="coBtnTot">0 ‚ÇΩ</span></button>
        </div>
      </div>
    </div>

    <!-- CHECKOUT -->
    <div class="screen" id="screen-checkout">
      <div class="scr-hdr"><button class="back-btn" onclick="G('cart')">‚Üê</button><span class="scr-t">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</span></div>
      <div class="co-sec">
        <div class="co-t">üì¶ –î–æ—Å—Ç–∞–≤–∫–∞</div>
        <div class="co-row" onclick="openAddr()">
          <div class="coic">üìç</div><div class="co-bd"><div class="col">–ê–¥—Ä–µ—Å</div><div class="cov" id="coAddr">‚Äî</div></div><span style="color:var(--gt)">‚Ä∫</span>
        </div>
        <div class="co-row">
          <div class="coic">‚è±Ô∏è</div><div class="co-bd"><div class="col">–í—Ä–µ–º—è</div><div class="cov" id="coTime">~30 –º–∏–Ω</div></div>
        </div>
      </div>
      <div class="co-sec">
        <div class="co-t">üí≥ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</div>
        <div class="pay-opts" id="payOpts">
          <div class="popt on" onclick="selPay(this,'sbp_qr','sbp')"><div class="poi">‚ö°</div><div class="pon">–°–ë–ü</div></div>
          <div class="popt" onclick="selPay(this,'cash','cash')"><div class="poi">üíµ</div><div class="pon">–ù–∞–ª–∏—á–Ω—ã–µ</div></div>
        </div>
        <button class="add-card-btn" onclick="openCardModal()">‚ûï –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É</button>
      </div>
      <div class="co-sec">
        <div class="co-t">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
        <input id="coComment" style="width:100%;border:1.5px solid var(--gb);border-radius:10px;padding:10px 12px;font-size:14px;outline:none;background:var(--bg)" placeholder="–î–æ–º–æ—Ñ–æ–Ω, —ç—Ç–∞–∂, –ø–æ–∂–µ–ª–∞–Ω–∏—è...">
      </div>
      <div class="co-sec">
        <div class="co-t">üßæ –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</div>
        <div id="coItems"></div>
        <div class="sdiv"></div>
        <div class="sr tot" style="margin-top:10px"><span class="sl">–ò—Ç–æ–≥–æ</span><span class="sv" id="coTot">0 ‚ÇΩ</span></div>
      </div>
      <button class="place-btn" id="placeBtn" onclick="placeOrder()">–ó–∞–∫–∞–∑–∞—Ç—å ¬∑ <span id="placeTot">0 ‚ÇΩ</span></button>
    </div>

    <!-- ORDER -->
    <div class="screen" id="screen-order">
      <div class="ord-wrap">
        <div class="ord-chk">‚úÖ</div>
        <div class="ord-t">–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!</div>
        <div class="ord-s">–†–µ—Å—Ç–æ—Ä–∞–Ω –Ω–∞—á–∞–ª –≥–æ—Ç–æ–≤–∏—Ç—å</div>
        <div class="ord-nr"><div class="onrl">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</div><div class="onrv" id="ordNr">‚Äî</div></div>
        <div class="tbox">
          <div class="ts"><div class="ts-dot tsd" id="s1">‚úì</div><div class="ts-line"></div><div class="ts-txt"><div class="ts-l">–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç</div><div class="ts-s" id="s1t"></div></div></div>
          <div class="ts"><div class="ts-dot tsa" id="s2">üç≥</div><div class="ts-line"></div><div class="ts-txt"><div class="ts-l">–†–µ—Å—Ç–æ—Ä–∞–Ω –≥–æ—Ç–æ–≤–∏—Ç</div><div class="ts-s" id="s2t">~20 –º–∏–Ω</div></div></div>
          <div class="ts"><div class="ts-dot tsp" id="s3">üõµ</div><div class="ts-line"></div><div class="ts-txt"><div class="ts-l">–ö—É—Ä—å–µ—Ä –≤ –ø—É—Ç–∏</div><div class="ts-s" id="s3t"></div></div></div>
          <div class="ts"><div class="ts-dot tsp" id="s4">üéâ</div><div class="ts-txt"><div class="ts-l">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</div><div class="ts-s" id="s4t"></div></div></div>
        </div>
        <button class="back-main" onclick="G('catalog');clearCart()">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="screen" id="screen-profile">
      <div class="prof-head">
        <div class="ph-row">
          <button class="back-btn" onclick="G('catalog')">‚Üê</button>
          <div class="ph-av">üë§</div>
          <div>
            <div class="ph-name" id="phName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="ph-uid" id="phUid"></div>
            <div class="ph-phone" id="phPhone"></div>
          </div>
        </div>
        <div class="prof-plus"><span class="pp-ic">‚≠ê</span><span class="pp-txt">–Ø–Ω–¥–µ–∫—Å –ü–ª—é—Å</span><span class="pp-st" id="ppSt">–ù–µ –∞–∫—Ç–∏–≤–µ–Ω</span></div>
      </div>
      <div class="pmenu">
        <div class="psec">
          <div class="pitem" onclick="G('orders')"><div class="pic2">üì¶</div><div class="pib"><div class="pit">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</div><div class="pis" id="piOrd">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div></div><span class="piar">‚Ä∫</span></div>
          <div class="pitem" onclick="G('addresses')"><div class="pic2">üìç</div><div class="pib"><div class="pit">–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</div><div class="pis" id="piAddr">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞</div></div><span class="piar">‚Ä∫</span></div>
          <div class="pitem" onclick="G('payments')"><div class="pic2">üí≥</div><div class="pib"><div class="pit">–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</div><div class="pis" id="piPay">–ö–∞—Ä—Ç—ã –∏ –∫–æ—à–µ–ª—å–∫–∏</div></div><span class="piar">‚Ä∫</span></div>
        </div>
        <div class="psec">
          <div class="pitem" onclick="G('promos')"><div class="pic2">üè∑Ô∏è</div><div class="pib"><div class="pit">–ü—Ä–æ–º–æ–∫–æ–¥—ã</div><div class="pis" id="piPromo">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –∏ —Å–∫–∏–¥–∫–∏</div></div><span class="piar">‚Ä∫</span></div>
          <div class="pitem" onclick="G('support')"><div class="pic2">üí¨</div><div class="pib"><div class="pit">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div><div class="pis">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å</div></div><span class="piar">‚Ä∫</span></div>
        </div>
      </div>
    </div>

    <!-- ORDERS -->
    <div class="screen" id="screen-orders">
      <div class="scr-hdr"><button class="back-btn" onclick="G('profile')">‚Üê</button><span class="scr-t">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</span></div>
      <div id="ordersC"><div class="spin-wrap"><div class="spin"></div></div></div>
    </div>

    <!-- ADDRESSES -->
    <div class="screen" id="screen-addresses">
      <div class="scr-hdr"><button class="back-btn" onclick="G('profile')">‚Üê</button><span class="scr-t">–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</span></div>
      <div style="height:12px"></div>
      <div id="addrC"><div class="spin-wrap"><div class="spin"></div></div></div>
    </div>

    <!-- PAYMENTS -->
    <div class="screen" id="screen-payments">
      <div class="scr-hdr"><button class="back-btn" onclick="G('profile')">‚Üê</button><span class="scr-t">–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</span></div>
      <div style="height:12px"></div>
      <div id="payC"><div class="spin-wrap"><div class="spin"></div></div></div>
    </div>

    <!-- PROMOS -->
    <div class="screen" id="screen-promos">
      <div class="scr-hdr"><button class="back-btn" onclick="G('profile')">‚Üê</button><span class="scr-t">–ü—Ä–æ–º–æ–∫–æ–¥—ã</span></div>
      <div style="height:12px"></div>
      <div id="promoC"><div class="spin-wrap"><div class="spin"></div></div></div>
    </div>

    <!-- SUPPORT -->
    <div class="screen" id="screen-support">
      <div class="scr-hdr"><button class="back-btn" onclick="G('profile')">‚Üê</button><span class="scr-t">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span></div>
      <div class="sup-wrap">
        <div class="sup-chat" id="supChat"><div class="smsg sbot">–ü—Ä–∏–≤–µ—Ç! –ü–æ–º–æ–≥—É —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ –∑–∞–∫–∞–∑—É üëã</div></div>
        <div class="sup-inp-row">
          <input class="sup-inp" id="supInp" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter')sendSup()">
          <button class="sup-send" onclick="sendSup()">‚û§</button>
        </div>
      </div>
    </div>

  </div>

  <div class="bottom-nav" id="bnav">
    <button class="nbtn on" id="nav-catalog" onclick="G('catalog')"><span class="nic">üè†</span><span class="nlbl">–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nbtn" id="nav-cart" onclick="G('cart')"><span class="nic">üõí<span class="cbdg" id="cbdg"></span></span><span class="nlbl">–ö–æ—Ä–∑–∏–Ω–∞</span></button>
    <button class="nbtn" id="nav-profile" onclick="G('profile')"><span class="nic">üë§</span><span class="nlbl">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ PARAMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _p=new URLSearchParams(location.search);
const TOKEN=_p.get('token')||'';
const DEVICE_ID=_p.get('device_id')||'9B57D76B-908D-4504-915D-381D08676F44';
const PX=_p.get('proxy')||'http://localhost:8888';
const IMG='https://eda.yandex.ru';
const TRUST_TOKEN='food_payment_c808ddc9'; // –∏–∑ HAR
const SES=(()=>([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)).toUpperCase())();

let LAT=56.34750920385357,LON=43.934390690686854;
let curAddr={short:'–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥',full:'–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥, –í–æ–ª–∂—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è, 8',city:'–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥',street:'–í–æ–ª–∂—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è',house:'8',country:'–†–æ—Å—Å–∏—è',uri:''};
let cart={},curRest=null,curScreen='catalog';
let mItem=null,mQty=1,mOpt=null;
let payId='sbp_qr',payType='sbp';
let RESTS=[],coData=null,addrTimer=null,suggestLog='';

const CATS=[{e:'üçî',n:'–ë—É—Ä–≥–µ—Ä—ã'},{e:'üç£',n:'–°—É—à–∏'},{e:'üçï',n:'–ü–∏—Ü—Ü–∞'},{e:'üçó',n:'–ö—É—Ä–∏—Ü–∞'},{e:'ü•ó',n:'–ü–ø-–µ–¥–∞'},{e:'üçú',n:'–ê–∑–∏—è'},{e:'üåÆ',n:'–§–∞—Å—Ç—Ñ—É–¥'},{e:'üç¶',n:'–î–µ—Å–µ—Ä—Ç—ã'},{e:'üç±',n:'–ö–æ–º–±–æ'}];

// ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function api(path,body,method,baseUrl){
  method=method||(body!=null?'POST':'GET');
  const base=baseUrl||PX+'/proxy';
  try{
    const o={method,headers:{'Content-Type':'application/json','X-Bearer':TOKEN,'X-Device-Id':DEVICE_ID,'X-Client-Session':SES}};
    if(body!=null)o.body=JSON.stringify(body);
    const r=await fetch(base+path,o);
    if(!r.ok){console.warn('[API]',r.status,path);return null}
    return await r.json();
  }catch(e){console.error('[API]',path,e);return null}
}
const A=p=>api(p,null,'GET');  // GET shorthand

// ‚îÄ‚îÄ IMG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function imgUrl(uri,w,h){
  if(!uri)return'';
  if(uri.startsWith('http'))return uri;
  return IMG+uri.replace('{w}',w||300).replace('{h}',h||200);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load',async()=>{
  document.getElementById('catsList').innerHTML=CATS.map((c,i)=>
    `<button class="cbt ${i===0?'on':''}" onclick="filterCat(this,'${c.n}')">
      <span class="cbe">${c.e}</span><span class="cbn">${c.n}</span>
    </button>`).join('');
  if(TOKEN){
    loadProfile();
    loadRests();
  }else{
    document.getElementById('restsList').innerHTML='<div style="text-align:center;padding:60px 24px;color:var(--gt);font-size:15px">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–Ω—é</div>';
    document.getElementById('addrTxt').textContent='–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å';
  }
  setTimeout(()=>{const l=document.getElementById('loading');l.style.opacity='0';setTimeout(()=>l.style.display='none',400)},800);
});

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// GET /api/v1/user/profile ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint –∏–∑ HAR
async function loadProfile(){
  const d=await A('/api/v1/user/profile');
  if(d){
    document.getElementById('phName').textContent=d.first_name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    document.getElementById('phUid').textContent=d.passport_uid?'UID: '+d.passport_uid:'';
    document.getElementById('phPhone').textContent=d.phone_number||'';
  }else{
    document.getElementById('phName').textContent='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
  }
  document.getElementById('addrTxt').textContent=curAddr.short;
  // Plus —Å—Ç–∞—Ç—É—Å
  const ps=await A(`/eats/v1/eats-plus/v1/status?latitude=${LAT}&longitude=${LON}`);
  if(ps&&Object.keys(ps).length>0){
    const el=document.getElementById('ppSt');
    el.textContent='‚úì –ê–∫—Ç–∏–≤–µ–Ω';el.style.color='#029154';
  }
}

// ‚îÄ‚îÄ RESTAURANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadRests(){
  document.getElementById('restsList').innerHTML='<div class="spin-wrap"><div class="spin"></div></div>';
  const d=await api('/eats/v1/layout-constructor/v1/layout',{
    filters_v2:{filters:[]},sort:'default',is_bottomsheet:false,
    selected_state:'online',location:{longitude:LON,latitude:LAT},region_id:17
  });
  if(d?.data){
    const ps=parsePlaces(d.data);
    if(ps.length){RESTS=ps;renderRests(RESTS);return}
  }
  document.getElementById('restsList').innerHTML='<div style="text-align:center;padding:40px;color:var(--gt)">–ù–µ—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –ø–æ —ç—Ç–æ–º—É –∞–¥—Ä–µ—Å—É</div>';
}

function parsePlaces(data){
  const secs=[...(data.places_v2_lists||[]),...(data.places_v2_medium_carousels||[]),...(data.places_v2_ultima_list||[]),...(data.mini_places_carousels||[])];
  const seen=new Set(),res=[];
  for(const s of secs){
    for(const p of(s.payload?.places||[])){
      if(!p.slug||seen.has(p.slug))continue;
      seen.add(p.slug);
      const name=typeof p.name==='object'?p.name.value:(p.name||'‚Äî');
      let time='';for(const m of(p.left_meta||[]))if(m.type==='info'){time=m.payload?.text?.value||'';break}
      let tags='';for(const m of(p.right_meta||[]))if(m.type==='info'){tags=m.payload?.text?.value||'';break}
      const tagArr=tags.split(',').map(t=>t.trim().replace(/\u200b/g,'')).filter(Boolean);
      const free=(p.chips||[]).some(c=>c.payload?.prefix?.text?.value?.toLowerCase().includes('–±–µ—Å–ø–ª–∞—Ç–Ω'));
      const rat=(p.features?.rating?.text?.value||'').match(/[\d.]+/)?.[0]||'';
      res.push({slug:p.slug,name,pic:p.picture?.image||'',time,tags:tagArr,free,rat});
    }
  }
  return res;
}

function filterCat(btn,cat){
  document.querySelectorAll('.cbt').forEach(b=>b.classList.remove('on'));btn.classList.add('on');
  const q=cat.toLowerCase();
  const f=RESTS.filter(r=>r.tags.some(t=>t.toLowerCase().includes(q)));
  renderRests(f.length?f:RESTS);
}
function filterR(q){
  if(!q){renderRests(RESTS);return}
  q=q.toLowerCase();
  renderRests(RESTS.filter(r=>r.name.toLowerCase().includes(q)||r.tags.some(t=>t.toLowerCase().includes(q))));
}
function renderRests(list){
  const el=document.getElementById('restsList');
  if(!list.length){el.innerHTML='<div style="text-align:center;padding:40px;color:var(--gt)">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';return}
  el.innerHTML=list.map(r=>{
    const pu=imgUrl(r.pic,600,300);
    return `<div class="rc" onclick="openRest('${r.slug}')">
      <div class="rc-img">${pu?`<img src="${pu}" loading="lazy" onerror="this.style.display='none'">`:'<span style="font-size:60px">üçΩÔ∏è</span>'}${r.free?'<div class="rc-badge">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</div>':''}</div>
      <div class="rc-info">
        <div class="rc-name">${r.name}</div>
        <div class="rc-meta">${r.rat?`<span class="rc-rat">‚òÖ ${r.rat}</span>`:''} ${r.time?`<span class="rc-time">‚è± ${r.time}</span>`:''} ${r.free?'<span class="rc-free">–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</span>':''}</div>
        ${r.tags.length?`<div class="rc-tags">${r.tags.slice(0,4).map(t=>`<span class="rc-tag">${t}</span>`).join('')}</div>`:''}
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ MENU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openRest(slug){
  curRest=RESTS.find(r=>r.slug===slug);if(!curRest)return;
  G('menu');
  document.getElementById('mhName').textContent=curRest.name;
  const pu=imgUrl(curRest.pic,800,400);
  document.getElementById('mhImg').innerHTML=pu?`<img src="${pu}" onerror="this.style.display='none'">`:'üçΩÔ∏è';
  document.getElementById('mhMeta').innerHTML=
    `${curRest.free?'<span class="mbadge mbg">–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</span>':''}
     ${curRest.time?`<span class="mbadge mby">‚è± ${curRest.time}</span>`:''}
     ${curRest.rat?`<span class="mbadge mby">‚òÖ ${curRest.rat}</span>`:''}`;
  document.getElementById('mCats').innerHTML='';
  document.getElementById('mItems').innerHTML='<div class="spin-wrap"><div class="spin"></div></div>';

  const d=await A(`/api/v2/menu/retrieve/${slug}?shippingType=delivery&longitude=${LON}&latitude=${LAT}&is_ad=false`);
  if(!d?.payload?.categories){document.getElementById('mItems').innerHTML='<div style="text-align:center;padding:40px;color:var(--gt)">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é</div>';return}

  curRest.cats=d.payload.categories.filter(c=>c.available!==false).map(c=>({
    n:c.name,
    items:(c.items||[]).filter(i=>i.available!==false).map(i=>({
      id:i.id,n:i.name,desc:i.description||'',p:i.price||0,
      img:i.picture?.uri?imgUrl(i.picture.uri,400,400):'',
      w:i.weightInGrams?i.weightInGrams+' –≥':'',
      opts:(i.optionsGroups||[]).map(g=>({g:g.name,req:g.required,i:(g.options||[]).map(o=>({id:o.id,n:o.name,p:o.price||0}))})).filter(g=>g.i.length)
    }))
  })).filter(c=>c.items.length);

  document.getElementById('mCats').innerHTML=curRest.cats.map((c,i)=>
    `<button class="mct ${i===0?'on':''}" onclick="scrollCat(${i},this)">${c.n}</button>`).join('');
  renderMenu();
}
function renderMenu(){
  document.getElementById('mItems').innerHTML=curRest.cats.map((c,ci)=>`
    <div class="msec" id="ms${ci}">
      <div class="msec-title">${c.n}</div>
      <div class="mitems">${c.items.map(i=>renderMI(i)).join('')}</div>
    </div>`).join('')+'<div style="height:80px"></div>';
}
function renderMI(item){
  const q=getQ(item.id);
  const js=JSON.stringify(item).replace(/'/g,"&#39;");
  return `<div class="mi" onclick='openIModal(${js})'>
    <div class="mi-img">${item.img?`<img src="${item.img}" loading="lazy" onerror="this.parentElement.innerHTML='üçΩÔ∏è'">`:'üçΩÔ∏è'}</div>
    <div class="mi-body">
      <div class="mi-name">${item.n}</div>
      ${item.desc?`<div class="mi-desc">${item.desc}</div>`:''}
      ${item.w?`<div class="mi-w">${item.w}</div>`:''}
      <div class="mi-foot">
        <div class="mi-price">${item.p} ‚ÇΩ</div>
        ${q>0?`<div class="qc"><button class="qb" onclick="event.stopPropagation();adjQ(${item.id},-1)">‚àí</button><span class="qn">${q}</span><button class="qb" onclick="event.stopPropagation();adjQ(${item.id},1)">+</button></div>`:`<button class="addbtn" onclick='event.stopPropagation();qAdd(${js})'>+</button>`}
      </div>
    </div>
  </div>`;
}
function scrollCat(i,btn){document.querySelectorAll('.mct').forEach(b=>b.classList.remove('on'));btn.classList.add('on');document.getElementById('ms'+i)?.scrollIntoView({behavior:'smooth',block:'start'})}

// ‚îÄ‚îÄ ITEM MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openIModal(item){
  if(typeof item==='string')item=JSON.parse(item);
  mItem=item;mQty=1;mOpt=null;
  document.getElementById('imodImg').innerHTML=(item.img?`<img src="${item.img}">`:'<span style="font-size:80px">üçΩÔ∏è</span>')+`<button class="imod-close" onclick="closeIModal()">‚úï</button>`;
  document.getElementById('imodName').textContent=item.n;
  document.getElementById('imodDesc').textContent=item.desc||'';
  document.getElementById('imodW').textContent=item.w||'';
  document.getElementById('iqNum').textContent='1';
  const ow=document.getElementById('imodOptsWrap');
  if(item.opts?.length){
    const g=item.opts[0];
    document.getElementById('imodOgTitle').textContent=g.g;
    document.getElementById('imodOpts').innerHTML=g.i.map((o,i)=>`<div class="iopt ${i===0?'on':''}" onclick='pickOpt(this,${JSON.stringify(o)})'><span class="iopt-n">${o.n}</span><span class="iopt-p">${o.p>0?'+'+o.p+' ‚ÇΩ':'–±–µ—Å–ø–ª–∞—Ç–Ω–æ'}</span></div>`).join('');
    mOpt=g.i[0];ow.style.display='block';
  }else{ow.style.display='none'}
  updMP();
  document.getElementById('imodal').classList.add('on');
}
function pickOpt(el,opt){if(typeof opt==='string')opt=JSON.parse(opt);document.querySelectorAll('.iopt').forEach(e=>e.classList.remove('on'));el.classList.add('on');mOpt=opt;updMP()}
function updMP(){if(!mItem)return;const p=mItem.p+(mOpt?.p||0);document.getElementById('imodPrice').textContent=(p*mQty)+' ‚ÇΩ'}
function iqAdj(d){mQty=Math.max(1,mQty+d);document.getElementById('iqNum').textContent=mQty;updMP()}
function addFromModal(){if(!mItem||!curRest)return;for(let i=0;i<mQty;i++)addCart(mItem,mOpt?.n||'',mOpt?.p||0);closeIModal();toast(mItem.n+' –¥–æ–±–∞–≤–ª–µ–Ω ‚úì')}
function closeIModal(){document.getElementById('imodal').classList.remove('on');mItem=null}
document.getElementById('imodal').addEventListener('click',e=>{if(e.target===document.getElementById('imodal'))closeIModal()});
function qAdd(item){if(typeof item==='string')item=JSON.parse(item);if(item.opts?.length){openIModal(item);return}addCart(item,'',0);toast(item.n+' –¥–æ–±–∞–≤–ª–µ–Ω ‚úì');renderMenu()}

// ‚îÄ‚îÄ CART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addCart(item,on,op){
  if(!cart.items)cart={slug:curRest.slug,rn:curRest.name,items:[]};
  if(cart.slug!==curRest.slug){if(!confirm(`–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É "${cart.rn}"?`))return;cart={slug:curRest.slug,rn:curRest.name,items:[]}}
  const key=item.id+'_'+on,ex=cart.items.find(i=>i.key===key);
  if(ex)ex.qty++;else cart.items.push({key,iid:item.id,n:item.n,p:item.p+op,img:item.img||'',on,qty:1});
  updBdg();
}
function adjQ(iid,d){
  if(!cart.items)return;
  const i=cart.items.findIndex(x=>x.iid===iid);if(i<0)return;
  cart.items[i].qty+=d;if(cart.items[i].qty<=0)cart.items.splice(i,1);
  if(!cart.items.length)cart={};
  updBdg();
  if(curScreen==='menu'&&curRest?.cats)renderMenu();
  if(curScreen==='cart')renderCart();
}
function getQ(iid){return cart.items?cart.items.filter(i=>i.iid===iid).reduce((s,i)=>s+i.qty,0):0}
function getTotal(){return cart.items?cart.items.reduce((s,i)=>s+i.p*i.qty,0):0}
function getCount(){return cart.items?cart.items.reduce((s,i)=>s+i.qty,0):0}
function updBdg(){const c=getCount();document.getElementById('cbdg').textContent=c>0?c:''}
function clearCart(){cart={};updBdg()}

function renderCart(){
  if(!cart.items?.length){document.getElementById('cartEmpty').style.display='flex';document.getElementById('cartFilled').style.display='none';return}
  document.getElementById('cartEmpty').style.display='none';document.getElementById('cartFilled').style.display='block';
  document.getElementById('cRName').textContent='üì¶ '+(cart.rn||'');
  document.getElementById('cItems').innerHTML=cart.items.map(ci=>`
    <div class="citem">
      <div class="cii">${ci.img?`<img src="${ci.img}" onerror="this.parentElement.innerHTML='üçΩÔ∏è'">`:'üçΩÔ∏è'}</div>
      <div class="cib"><div class="cin">${ci.n}</div>${ci.on?`<div class="cio">${ci.on}</div>`:''}</div>
      <div class="cqc">
        <div style="font-size:14px;font-weight:800">${ci.p*ci.qty} ‚ÇΩ</div>
        <div class="cqcc"><button class="cqb" onclick="adjQ(${ci.iid},-1)">‚àí</button><span class="cqn">${ci.qty}</span><button class="cqb" onclick="adjQ(${ci.iid},1)">+</button></div>
      </div>
    </div>`).join('');
  const sub=getTotal(),fee=Math.round(sub*.05),tot=sub+fee;
  document.getElementById('sItems').textContent=sub+' ‚ÇΩ';
  document.getElementById('sFee').textContent=fee+' ‚ÇΩ';
  document.getElementById('sTot').textContent=tot+' ‚ÇΩ';
  document.getElementById('coBtnTot').textContent=tot+' ‚ÇΩ';
}

// ‚îÄ‚îÄ PROMO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function applyPromo(){
  const code=document.getElementById('promoInp').value.trim().toUpperCase();
  if(!code){toast('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥');return}
  toast('‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é...');
  const d=await api(`/api/v2/cart/promocode?placeSlug=${cart.slug||''}&soft_multi=true&shippingType=delivery`,
    {code,place_slug:cart.slug||'',location:{latitude:LAT,longitude:LON}});
  toast(d&&(d.discount||d.applied)?'‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω!':'‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç');
}

// ‚îÄ‚îÄ CHECKOUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderCO(){
  const sub=getTotal(),fee=Math.round(sub*.05),tot=sub+fee;
  document.getElementById('coTot').textContent=tot+' ‚ÇΩ';
  document.getElementById('placeTot').textContent=tot+' ‚ÇΩ';
  document.getElementById('coItems').innerHTML=(cart.items||[]).map(ci=>
    `<div class="sr"><span class="sl">${ci.n}${ci.on?' ('+ci.on+')':''} √ó${ci.qty}</span><span class="sv">${ci.p*ci.qty} ‚ÇΩ</span></div>`).join('');
  document.getElementById('coAddr').textContent=curAddr.short;

  if(cart.slug&&TOKEN){
    const d=await api('/api/v2/cart/go-checkout',{
      address:buildAddr(),place_slug:cart.slug,plus_subscription_toggle_state:null
    });
    if(d){
      coData=d;
      if(d.address?.short_text)document.getElementById('coAddr').textContent=d.address.short_text;
      if(d.delivery_time)document.getElementById('coTime').textContent='~'+d.delivery_time+' –º–∏–Ω';
      if(d.payment_methods?.length)renderPayMethods(d.payment_methods);
    }
  }
}

function renderPayMethods(methods){
  const icons={sbp:'‚ö°',card:'üí≥',cash:'üíµ',wallet:'üëõ',yandex_pay:'üíõ'};
  const names={sbp:'–°–ë–ü',card:'–ö–∞—Ä—Ç–∞',cash:'–ù–∞–ª–∏—á–Ω—ã–µ',wallet:'–ö–æ—à–µ–ª—ë–∫',yandex_pay:'Pay'};
  let first=true;
  document.getElementById('payOpts').innerHTML=methods.map(m=>{
    const t=m.type||'card';const id=m.payment_method_id||t;
    const title=m.title||m.shortTitle||names[t]||t;
    const sel=first?'on':'';if(first){payId=id;payType=t;first=false}
    return `<div class="popt ${sel}" onclick="selPay(this,'${id}','${t}')"><div class="poi">${icons[t]||'üí≥'}</div><div class="pon" style="font-size:10px;max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${title}</div></div>`;
  }).join('');
}

function selPay(el,id,type){document.querySelectorAll('.popt').forEach(o=>o.classList.remove('on'));el.classList.add('on');payId=id;payType=type}

function buildAddr(){
  return{location:{longitude:LON,latitude:LAT},house:curAddr.house||'8',
    short_text:curAddr.short,full_text:curAddr.full,uri:curAddr.uri||'',
    city:curAddr.city||'',street:curAddr.street||'',country:curAddr.country||'–†–æ—Å—Å–∏—è',
    type:{id:0},areas:[curAddr.city||'']};
}

async function placeOrder(){
  const btn=document.getElementById('placeBtn');btn.disabled=true;btn.textContent='‚è≥ –û—Ñ–æ—Ä–º–ª—è—é...';
  let nr=null;
  if(TOKEN&&cart.slug){
    const reqId=crypto.randomUUID().replace(/-/g,'')+'.'+(coData?.offers?.[0]?.offer_identity||crypto.randomUUID().replace(/-/g,''));
    const d=await api('/api/v1/orders',{
      courier_options:[],persons_quantity:1,request_id:reqId,
      location:{latitude:LAT,longitude:LON},
      comment:document.getElementById('coComment').value,
      payment:{recently_link_cards:false},
      payment_method_id:payType==='sbp'?5:payType==='cash'?1:2,
      place_slug:cart.slug,phone:'+70000000000',
      extended_options:[{type:'delivery_options'}],
      address:buildAddr(),
      payment_information:{type:payType,id:payId,costForCustomer:String(getTotal())}
    });
    if(d?.order_nr)nr=d.order_nr;
  }
  if(!nr){const dt=new Date();nr=`${String(dt.getDate()).padStart(2,'0')}${String(dt.getMonth()+1).padStart(2,'0')}${String(dt.getFullYear()).slice(-2)}-${Math.floor(1000000+Math.random()*9000000)}`}
  clearCart();trackOrder(nr);
  btn.disabled=false;btn.textContent='–ó–∞–∫–∞–∑–∞—Ç—å ¬∑ 0 ‚ÇΩ';
}
function trackOrder(nr){
  document.getElementById('ordNr').textContent=nr;
  const f=d=>d.getHours()+':'+String(d.getMinutes()).padStart(2,'0');
  document.getElementById('s1t').textContent=f(new Date());
  G('order');
  setTimeout(()=>{document.getElementById('s2').textContent='‚úì';document.getElementById('s2').className='ts-dot tsd';document.getElementById('s3').className='ts-dot tsa';document.getElementById('s3t').textContent='~10 –º–∏–Ω'},9000);
  setTimeout(()=>{document.getElementById('s3').textContent='‚úì';document.getElementById('s3').className='ts-dot tsd';document.getElementById('s4').className='ts-dot tsa';document.getElementById('s4t').textContent=f(new Date(Date.now()+6*60000))},20000);
}

// ‚îÄ‚îÄ ADD CARD (trust.yandex.ru) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openCardModal(){
  toast('‚è≥ –û—Ç–∫—Ä—ã–≤–∞—é —Ñ–æ—Ä–º—É –∫–∞—Ä—Ç—ã...');
  // POST https://trust.yandex.ru/web/create_verification_intent
  // –ü—Ä–æ–∫—Å–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ –Ω–∞—à –ø—Ä–æ–∫—Å–∏ –Ω–∞ trust.yandex.ru
  let formUrl=null;
  try{
    const r=await fetch(PX+'/proxy-trust/web/create_verification_intent?service_token='+TRUST_TOKEN,{
      method:'POST',
      headers:{'Content-Type':'application/json','X-Bearer':TOKEN,'X-Device-Id':DEVICE_ID,'X-Client-Session':SES},
      body:JSON.stringify({currency:'RUB',form_params:{integrationProfileId:'yandex_default',mode:'spin',flow:'card',query_params:{theme:'light',lang:'ru',layout:'compact'}}})
    });
    if(r.ok){const d=await r.json();formUrl=d?.form_url}
  }catch(e){console.warn('trust api error',e)}
  if(!formUrl){
    // fallback: –æ—Ç–∫—Ä—ã—Ç—å –Ω–∞–ø—Ä—è–º—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏–≤—è–∑–∫–∏ –∫–∞—Ä—Ç—ã
    formUrl='https://trust.yandex.ru/web/binding?lang=ru&layout=compact&theme=light';
  }
  document.getElementById('cardFrame').src=formUrl;
  document.getElementById('cardModal').classList.add('on');
}
function closeCardModal(){document.getElementById('cardModal').classList.remove('on');document.getElementById('cardFrame').src='about:blank';loadPayments()}

// ‚îÄ‚îÄ ADDRESS SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// POST /eats/v1/persuggest/v1/zerosuggest ‚Äî –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ (—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞)
// POST /eats/v1/persuggest/v1/suggest ‚Äî –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞
// POST /eats/v1/persuggest/v1/finalsuggest ‚Äî –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

function openAddr(){document.getElementById('addrModal').classList.add('on');setTimeout(()=>document.getElementById('addrInp').focus(),350);loadZeroSuggest()}
function closeAddr(){document.getElementById('addrModal').classList.remove('on')}

async function loadZeroSuggest(){
  const d=await api('/eats/v1/persuggest/v1/zerosuggest',{
    type:'a',position:[LON,LAT],
    state:{current_mode:'eats',location:[LON,LAT],bbox:[LON-0.2,LAT-0.15,LON+0.2,LAT+0.15]}
  });
  const res=d?.results||[];
  const el=document.getElementById('addrRes');
  el.innerHTML=`<div class="addr-ri" onclick="useGeo()"><div class="aric">üéØ</div><div><div class="arim">–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div><div class="aris">–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div></div></div>`
    +res.map(r=>`<div class="addr-ri" onclick='pickSuggest(${JSON.stringify(r).replace(/'/g,"&#39;")})'>
      <div class="aric">‚è±Ô∏è</div>
      <div><div class="arim">${r.title?.text||r.short_text||''}</div><div class="aris">${r.subtitle?.text||r.text||''}</div></div>
    </div>`).join('');
}

function onAddrInput(v){
  clearTimeout(addrTimer);
  if(!v.trim()){loadZeroSuggest();return}
  if(v.length<2)return;
  addrTimer=setTimeout(()=>doSuggest(v),380);
}

async function doSuggest(part){
  const d=await api('/eats/v1/persuggest/v1/suggest',{
    action:'user_input',type:'a',part,
    state:{current_mode:'eats',bbox:[LON-0.2,LAT-0.15,LON+0.2,LAT+0.15]}
  });
  const res=d?.results||[];
  const el=document.getElementById('addrRes');
  if(!res.length){el.innerHTML=`<div class="addr-ri" onclick="useGeo()"><div class="aric">üéØ</div><div><div class="arim">–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div></div></div><div style="text-align:center;padding:32px;color:var(--gt)">–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω</div>`;return}
  el.innerHTML=res.map(r=>{
    const logStr=JSON.stringify(r.log||'').replace(/'/g,"&#39;");
    const rStr=JSON.stringify(r).replace(/'/g,"&#39;");
    return `<div class="addr-ri" onclick='selectSuggest(${rStr})'>
      <div class="aric">üìç</div>
      <div><div class="arim">${r.title?.text||r.short_text||''}</div><div class="aris">${r.subtitle?.text||''}</div></div>
    </div>`;
  }).join('');
}

async function selectSuggest(r){
  if(typeof r==='string')r=JSON.parse(r);
  // finalsuggest –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
  const d=await api('/eats/v1/persuggest/v1/finalsuggest',{
    action:'finalize',type:'a',prev_log:r.log||''
  });
  const res=(d?.results||[])[0]||r;
  pickSuggest(res);
}

function pickSuggest(r){
  if(typeof r==='string')r=JSON.parse(r);
  // position –≤ persuggest: [lon, lat]
  const pos=r.position||[];
  if(pos.length>=2){LON=pos[0];LAT=pos[1]}
  curAddr={
    short:r.short_text||r.title?.text||r.text||'',
    full:r.text||r.full||'',
    city:r.city||'',street:r.street||'',house:r.house||'',
    country:r.country||'–†–æ—Å—Å–∏—è',uri:r.uri||''
  };
  document.getElementById('addrTxt').textContent=curAddr.short;
  closeAddr();
  toast('üìç '+curAddr.short);
  RESTS=[];loadRests();
}

function useGeo(){
  if(!navigator.geolocation){toast('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');return}
  toast('‚è≥ –û–ø—Ä–µ–¥–µ–ª—è—é...');
  navigator.geolocation.getCurrentPosition(async pos=>{
    LON=pos.coords.longitude;LAT=pos.coords.latitude;
    // pin_drop finalsuggest –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
    const d=await api('/eats/v1/persuggest/v1/finalsuggest',{
      action:'pin_drop',type:'a',state:{current_mode:'eats'},position:[LON,LAT]
    });
    const res=(d?.results||[])[0];
    if(res)pickSuggest(res);
    else{curAddr={short:`${LAT.toFixed(4)}, ${LON.toFixed(4)}`,full:'',city:'',street:'',house:'',country:'–†–æ—Å—Å–∏—è',uri:''};document.getElementById('addrTxt').textContent=curAddr.short;closeAddr();RESTS=[];loadRests()}
  },()=>toast('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é'));
}

// ‚îÄ‚îÄ PROFILE SUBSCREENS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ORDERS ‚Äî POST /eats/v1/orders-info/v1/orders
async function loadOrders(){
  const el=document.getElementById('ordersC');el.innerHTML='<div class="spin-wrap"><div class="spin"></div></div>';
  const d=await api('/eats/v1/orders-info/v1/orders',{goods_items_limit:6});
  const orders=d?.orders||[];
  if(!orders.length){el.innerHTML='<div class="empty"><div class="eic">üì¶</div><div class="etx">–ó–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç</div><div class="esb">–°–¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑!</div></div>';return}
  document.getElementById('piOrd').textContent=orders.length+' –∑–∞–∫–∞–∑–æ–≤';
  el.innerHTML='<div class="olist">'+orders.map(o=>{
    const g=o.widgets?.general||{};
    const items=(o.widgets?.goods?.items||[]);
    const statusTxt=g.status?.text||'–î–æ—Å—Ç–∞–≤–ª–µ–Ω';
    const stcls=statusTxt.includes('–î–æ—Å—Ç–∞–≤–ª–µ–Ω')?'ob-ok':statusTxt.includes('–û—Ç–º–µ–Ω—ë–Ω')?'ob-no':'ob-pend';
    const imgs=items.slice(0,3).map(i=>i.image_url_pattern?`<img class="oci-img" src="${i.image_url_pattern.replace('{w}','80').replace('{h}','80')}" onerror="this.style.display='none'">`:'').join('');
    return `<div class="ocard">
      <div class="och"><span class="ocn">–ó–∞–∫–∞–∑ ${g.deeplink?.split('=')[1]||o.order_nr||'‚Äî'}</span><span class="ocd">${g.date||''}</span></div>
      <div class="ocr">${g.name||''}</div>
      ${imgs?`<div class="oci">${imgs}</div>`:''}
      <div class="ocf"><span class="oct">${g.cost_value||0} ${g.currency?.sign||'‚ÇΩ'}</span><span class="obdg ${stcls}">${statusTxt}</span></div>
    </div>`;
  }).join('')+'</div>';
}

// ADDRESSES ‚Äî GET /api/v3/user/addresses (v3!)
async function loadAddrScreen(){
  const el=document.getElementById('addrC');el.innerHTML='<div class="spin-wrap"><div class="spin"></div></div>';
  const addrs=await A('/api/v3/user/addresses');
  const list=Array.isArray(addrs)?addrs:[];
  // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
  let html=`<div class="acard" onclick="openAddr()">
    <div class="aci">üìç</div>
    <div class="acb"><div class="acn">–¢–µ–∫—É—â–∏–π –∞–¥—Ä–µ—Å</div><div class="acs">${curAddr.full||curAddr.short}</div></div>
    <div style="font-size:12px;color:var(--gt)">–ò–∑–º–µ–Ω–∏—Ç—å</div>
  </div>`;
  if(list.length){
    document.getElementById('piAddr').textContent=list.length+' –∞–¥—Ä–µ—Å–æ–≤';
    html+=list.map(a=>{
      const types={0:'üè†',1:'üè¢',2:'üìç'};
      const ic=types[a.type?.id]||'üìç';
      return `<div class="acard" onclick="pickSavedAddr(${JSON.stringify(a).replace(/'/g,"&#39;")})">
        <div class="aci">${ic}</div>
        <div class="acb"><div class="acn">${a.title||a.short_text||'–ê–¥—Ä–µ—Å'}</div><div class="acs">${a.full_text||''}</div></div>
      </div>`;
    }).join('');
  }else{html+='<div style="text-align:center;padding:30px;color:var(--gt);font-size:14px">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ –Ω–µ—Ç</div>'}
  el.innerHTML=html;
}

function pickSavedAddr(a){
  if(typeof a==='string')a=JSON.parse(a);
  if(a.location){LAT=a.location.latitude;LON=a.location.longitude}
  curAddr={short:a.short_text||a.title||'',full:a.full_text||'',city:a.city||'',street:a.street||'',house:a.house||'',country:a.country||'–†–æ—Å—Å–∏—è',uri:a.uri||''};
  document.getElementById('addrTxt').textContent=curAddr.short;
  toast('üìç '+curAddr.short);
  RESTS=[];loadRests();
}

// PAYMENTS ‚Äî –∏–∑ go-checkout (—Ç–∞–º –ø—Ä–∏—Ö–æ–¥—è—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã) + –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É
async function loadPayments(){
  const el=document.getElementById('payC');el.innerHTML='<div class="spin-wrap"><div class="spin"></div></div>';
  const d=await api('/api/v2/cart/go-checkout',{
    address:buildAddr(),place_slug:cart.slug||(RESTS[0]?.slug)||'',plus_subscription_toggle_state:null
  });
  const methods=d?.payment_methods||[];
  const icons={sbp:'‚ö°',card:'üí≥',cash:'üíµ',wallet:'üëõ',yandex_pay:'üíõ'};
  const colors={sbp:'#e8f8ee',card:'#eef2ff',cash:'#fff5d0',wallet:'#fef9ee',yandex_pay:'#fffbe8'};
  let html='';
  if(methods.length){
    document.getElementById('piPay').textContent=methods.length+' —Å–ø–æ—Å–æ–±–æ–≤';
    html=methods.map(m=>{
      const t=m.type||'card';
      return `<div class="paycard">
        <div class="pci" style="background:${colors[t]||'#f5f5f5'}">${icons[t]||'üí≥'}</div>
        <div class="pcb"><div class="pcn">${m.title||m.name||t}</div>${m.shortTitle&&m.shortTitle!==m.title?`<div class="pcs">${m.shortTitle}</div>`:''}</div>
      </div>`;
    }).join('');
  }else{
    // –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    html=['‚ö°|–°–ë–ü|#e8f8ee','üíµ|–ù–∞–ª–∏—á–Ω—ã–µ|#fff5d0'].map(s=>{const[ic,nm,bg]=s.split('|');return`<div class="paycard"><div class="pci" style="background:${bg}">${ic}</div><div class="pcb"><div class="pcn">${nm}</div></div></div>`}).join('');
  }
  html+=`<button class="add-pay-btn" onclick="openCardModal()">‚ûï –ü—Ä–∏–≤—è–∑–∞—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫—É—é –∫–∞—Ä—Ç—É</button>`;
  el.innerHTML=html;
}

// PROMOS ‚Äî POST /eats/v1/coupons/referral + POST /api/v1/user/promocodes
async function loadPromos(){
  const el=document.getElementById('promoC');el.innerHTML='<div class="spin-wrap"><div class="spin"></div></div>';
  const [ref,promo]=await Promise.all([
    api('/eats/v1/coupons/referral',''),
    api('/api/v1/user/promocodes',{cart_id:cart.key||''})
  ]);
  let html='';
  // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –∫—É–ø–æ–Ω—ã
  const coupons=ref?.coupons||[];
  coupons.forEach(c=>{
    html+=`<div class="promocard">
      <div class="promoCode">${c.promocode||''}</div>
      <div class="promoDesc">${c.title?.value||''}</div>
      <div style="font-size:12px;color:var(--gt);margin-top:4px">${c.description?.value?.slice(0,120)||''}</div>
      ${c.promocode?`<span class="promoBdg">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π</span>`:''}
    </div>`;
  });
  // –õ–∏—á–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
  const promos=promo?.promocodes||[];
  promos.forEach(p=>{
    html+=`<div class="promocard">
      <div class="promoCode">${p.code||''}</div>
      <div class="promoDesc">${p.description||p.title||''}</div>
      ${p.discount?`<span class="promoBdg">‚àí${p.discount}</span>`:''}
    </div>`;
  });
  if(!html)html='<div class="empty"><div class="eic">üè∑Ô∏è</div><div class="etx">–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ—Ç</div></div>';
  else document.getElementById('piPromo').textContent=(coupons.length+promos.length)+' –ø—Ä–æ–º–æ–∫–æ–¥–∞(–æ–≤)';
  el.innerHTML=html;
}

// SUPPORT
function sendSup(){
  const inp=document.getElementById('supInp');const txt=inp.value.trim();if(!txt)return;
  const c=document.getElementById('supChat');
  c.innerHTML+=`<div class="smsg susr">${txt}</div>`;inp.value='';c.scrollTop=c.scrollHeight;
  const rs=['–°–ø–∞—Å–∏–±–æ! –í–∞—à –≤–æ–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä—É.','–û–±—ã—á–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç.','–ó–∞–ø—Ä–æ—Å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ #'+Math.floor(10000+Math.random()*90000),'–†–∞—Å—Å–º–æ—Ç—Ä–∏–º –∫–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ!'];
  setTimeout(()=>{c.innerHTML+=`<div class="smsg sbot">${rs[Math.floor(Math.random()*rs.length)]}</div>`;c.scrollTop=c.scrollHeight},1400);
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PROF_SCR=new Set(['profile','orders','addresses','payments','promos','support']);
const NO_NAV=new Set(['checkout','order']);
const NO_TOP=new Set(['menu','cart','checkout','order','orders','addresses','payments','promos','support','profile']);
const NO_TABS=new Set(['menu','cart','checkout','order','orders','addresses','payments','promos','support','profile']);

function G(scr){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('on'));
  document.getElementById('screen-'+scr)?.classList.add('on');
  document.querySelectorAll('.nbtn').forEach(b=>b.classList.remove('on'));
  document.getElementById('nav-'+scr)?.classList.add('on');
  if(PROF_SCR.has(scr))document.getElementById('nav-profile').classList.add('on');
  if(scr==='catalog')document.getElementById('nav-catalog').classList.add('on');
  if(scr==='cart')document.getElementById('nav-cart').classList.add('on');
  document.getElementById('mainTopbar').style.display=NO_TOP.has(scr)?'none':'block';
  document.getElementById('mainTabs').style.display=NO_TABS.has(scr)?'none':'flex';
  document.getElementById('bnav').style.display=NO_NAV.has(scr)?'none':'flex';
  if(scr==='cart')renderCart();
  if(scr==='checkout')renderCO();
  if(scr==='orders')loadOrders();
  if(scr==='addresses')loadAddrScreen();
  if(scr==='payments')loadPayments();
  if(scr==='promos')loadPromos();
  curScreen=scr;
  document.getElementById('mainContent').scrollTo(0,0);
}

function selTab(t,btn){document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));btn.classList.add('on');if(t==='offline')toast('–ö–∞—Ä—Ç–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')}

let toastT;
function toast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('on');clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('on'),2800)}

G('catalog');
</script>
</body>
</html>
